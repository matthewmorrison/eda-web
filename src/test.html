<!DOCTYPE html>
<html>
<head>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js" ></script>
	<script src="fabric.min.js" ></script>
</head>
<body>	
	<div class="canvas-scroll">
		<canvas id="canvas" width="1280" height="1024" style="border: 1px solid #888" />
	</div>
	<script>

	var canvas = new fabric.Canvas('canvas');
	//canvas.centeredScaling = true;
	var copiedObjects = new Array();
	var canvasScale = 1;
	var SCALE_FACTOR = 1.2;
	var PAN_STEP = 1.1;
	
	function Component() {
		this.group = null;
		this.name = null;
		this.reference = null;
		this.textOffset = null;
		this.drawPinNumber = null;
		this.drawPinName = null;
		this.unitCount = null;
		this.unitsLocked = null;
		this.powerFlag = null;
		this.aliases = [];
		this.fields = {};
		this.elements = [];
	}
	
	Component.prototype.parseComponent = function(def) {			
		var line = -1;
		try {
			var lines = def.split('\n');
			var section = '';
			
			for(var l_index = 0; l_index < lines.length; l_index++) {
				var line = lines[l_index];
				if(line[0] != '#') { //Skip comments
					var props = line.match(/(?:[^\s"]+|"[^"]*")+/g);

					if(props[0] == 'ENDDEF')
						return;
					
					if(section == 'draw') {
						if(props[0] == 'ENDDRAW') {
							section = '';
						}
						else {
							this.parseDrawField(props);
						}
					}
					else {
						if(this.name == null) {
							validatePropertyCount(props.length, 10, 10);
							
							if(props[0] == 'DEF') {
								this.parseComponentDefinition(props);
							}
							else 
								throw '"DEF" expected, but found "' + props[0] + '"';
						}
						else if(props[0] == 'ALIAS') {
							this.aliases = props.splice(1, props.length - 1);
						}
						else if(props[0][0] == 'F') {
							this.parseComponentField(props);
						}
						else if(props[0] == 'DRAW') {
							section = 'draw';
						}
					}
				}
			}	
		}
		catch(e) {
			throw '[Component Line ' + line + '] Error parsing component: ' + e;
		}
	}
	
	Component.prototype.parseComponentDefinition = function(props) {
		this.name = props[1];
		this.reference = props[2];
		this.textOffset = props[4];
		this.drawPinNumber = props[5];
		this.drawPinName = props[6];
		this.unitCount = props[7];
		this.unitsLocked = props[8];
		this.powerFlag = props[9];
	}
	
	Component.prototype.parseComponentField = function(props) {
		var field = {
			name: props[1],
			position: { x: props[2], y: props[3] },
			dimension: props[4],
			orientation: props[5],
			visible: props[6],
			hjustify: props[7],
			vjustifyItalicBold: props[8][0]
		};
		
		this.fields[props[0]] = field;
	}
	
	Component.prototype.parseDrawField = function(props) {
		var type = props[0];

		if(type == 'P') { // polygon
			var p = { 
				'type': type,
				'Nb': props[1], 
				'parts': props[2], 
				'convert': props[3],
				'thickness': props[4], 
				'points': [
					[ props[5], props[6] ],
					[ props[7], props[8] ]
				]
			};
			
			for(var i = 9; i < props.length -1; i+=2) {
				p.points.push([ props[i], props[i+1] ]);
			}
			
			this.elements.push(p);
		}
		else if(type == 'S'){ // rectangle (square)
			this.elements.push({
				'type': type, 
				'x0': props[1],
				'y0': props[2], 
				'x1': props[3], 
				'y1': props[4],
				'unit': props[5], 
				'convert': props[6],
				'thickness': props[7],
				'cc': props[8]
			});
		}
		else if(type == 'C') {
			this.elements.push({
				'type': type, 
				'x0': props[1],
				'y0': props[2], 
				'radius': props[3], 
				'unit': props[4],
				'convert': props[5], 
				'thickness': props[6],
				'cc': props[7]
			});
		}
		else if(type == 'A') {
			this.elements.push({
				'type': type, 
				'x0': props[1],
				'y0': props[2], 
				'radius': props[3], 
				'start': props[4],
				'end': props[5], 
				'part': props[6],
				'convert': props[7],
				'thickness': props[8],
				'cc': props[9],
				'pX0': props[10],
				'pY0': props[11],
				'pX1': props[12],
				'pY1': props[13]
			});
		}
		else if(type == 'T') {
			this.elements.push({
				'type': type, 
				'orientation': props[1],
				'x0': props[2], 
				'y0': props[3], 
				'dimension': props[4],
				'unit': props[5], 
				'convert': props[6],
				'text': props[7]
			});
		}
		else if(type == 'X') {
			this.elements.push({
				'type': props[0], 
				'name': props[1],
				'number': props[2], 
				'x0': props[3], 
				'y0': props[4],
				'length': props[5], 
				'orientation': props[6],
				'snum': props[7],
				'snom': props[8],
				'unit': props[9],
				'convert': props[10],
				'etype': props[11],
				'shape': props[12] //optional
			});
		}
		else {
			throw 'Unexpected draw directive "' + type + '"';
		}
	}
	
	Component.prototype.draw = function() {
		console.log('here ', this.group);
	
		if(this.group != null) {
			return;
		}
		
		//this.group = new fabric.Group();
		
		for(var i = 0; i < this.elements.length; i++) {
			var el = this.elements[i];
			
			if(el.type == 'P') {
				var path = 'M ' + el.points[0][0] + ' ' + el.points[0][1] + 
					' L ' + el.points[1][0] + ' ' + el.points[1][1] + ' z';
					
				for(var j = 2; j < el.points.length; j++) {
					path += ' L ' + el.points[j][0] + ' ' + el.points[j][1];
				}
				
				var path = new fabric.Path(path);
				path.set({ fill: 'red', stroke: 'black', strokeWidth: 5, top:  });
				//this.group.addWithUpdate(path);
				canvas.add(path);
			}
		}
		
		//canvas.add(this.group);
		//this.group.center();
	}
		
	function validatePropertyCount(count, min, max) {
		if(min && count < min)
			throw 'Expected a minimum of ' + min + ' properties, but found ' + count;
			
		if(max && count > max)
			throw 'Expected a maximum of ' + max + ' properties, but found ' + count;
	}
	
	function zoomIn() {
		// TODO limit the max canvas zoom in
		//console.log(canvas.getZoom());
		//canvas.setZoom(canvas.getZoom()+SCALE_FACTOR);

		var objects = canvas.getObjects();		
		canvasScale = canvasScale * SCALE_FACTOR;
		var center = canvas.getCenter();
		var x = $('#canvas').data('mouseX');
		var y = $('#canvas').data('mouseY');

		for (var i in objects) {
			var scaleX = objects[i].scaleX;
			var scaleY = objects[i].scaleY;
			var left = objects[i].left;
			var top = objects[i].top;

			var tempScaleX = scaleX * SCALE_FACTOR;
			var tempScaleY = scaleY * SCALE_FACTOR;
			var tempLeft = left * SCALE_FACTOR - x * .2;
			var tempTop = top * SCALE_FACTOR - y * .2;
			
			objects[i].scaleX = tempScaleX;
			objects[i].scaleY = tempScaleY;
			objects[i].left = tempLeft;
			objects[i].top = tempTop;
			
			objects[i].setCoords();
		}
			
		canvas.renderAll();
	}

	// Zoom Out
	function zoomOut() {
		// TODO limit max cavas zoom out
		
		//console.log(canvas.getZoom());
		//canvas.setZoom(canvas.getZoom() - SCALE_FACTOR);

		var objects = canvas.getObjects();		
		canvasScale = canvasScale / SCALE_FACTOR;
		var center = canvas.getCenter();

		for (var i in objects) {
			var scaleX = objects[i].scaleX;
			var scaleY = objects[i].scaleY;
			var left = objects[i].left;
			var top = objects[i].top;
		
			var tempScaleX = scaleX * (1 / SCALE_FACTOR);
			var tempScaleY = scaleY * (1 / SCALE_FACTOR);
			var tempLeft = left * (1 / SCALE_FACTOR) + center.left * (.2 / SCALE_FACTOR);
			var tempTop = top * (1 / SCALE_FACTOR) + center.top * (.2 / SCALE_FACTOR);

			console.log(objects[i].left, '->', tempLeft);
			
			objects[i].scaleX = tempScaleX;
			objects[i].scaleY = tempScaleY;
			objects[i].left = tempLeft;
			objects[i].top = tempTop;

			objects[i].setCoords();
		}
		
		canvas.renderAll();
	}
	
	function panHorizontal(steps) {
		var objects = canvas.getObjects();
		var step = PAN_STEP * steps;
	
		for (var i in objects) {
			objects[i].left += step;
			objects[i].setCoords();
		}
		
		canvas.renderAll();
	}
	
	function panVertical(steps) {
		var objects = canvas.getObjects();
		var step = PAN_STEP * steps;
	
		for (var i in objects) {
			objects[i].top += step;
			objects[i].setCoords();
		}
		
		canvas.renderAll();
	}
	
	function resetView() {
		var objects = canvas.getObjects();
		
		for(var i in objects) {
			objects[i].center();
		}
		
		canvas.setZoom(1);
		
		canvas.renderAll();
		
		/*var left = 10000;
		var top = 10000;
		var right = -10000;
		var bottom = -10000;
		var objects = canvas.getObjects();
		
		for(var i in objects) {
			var oleft = objects[i].left;
			var otop = objects[i].top;
			var owidth = objects[i].width;
			var oheight = objects[i].height;
		
			if(oleft < left)
				left = oleft;
			
			if(owidth + oleft > right)
				right = owidth + oleft;
			
			if(otop < top)
				top = otop;
			
			if(otop + oheight > bottom)
				bottom = otop + oheight;
				
			objects[i].center();
		}
		
		var cwidth = $('#canvas').width();
		var cheight = $('#canvas').height();
		
		console.log(left, ', ', top, ', ', right, ', ', ', ', bottom);
		
		canvas.renderAll();
		return;
		//var height = (bottom - top)/2;
		
		console.log(shiftx);
		
		for (var i in objects) {
			objects[i].left += shiftx;
			objects[i].setCoords();
		}
		
		canvas.renderAll();*/
	}
	
	$(function() {
		var testComp = 'DEF BEAD ?? 0 40 Y Y 1 L N\r\n' +
'ALIAS one two three\r\n' +
'F0 "??" 0 0 60 H V C CNN\r\n' +
'F1 "BEAD" 0 0 60 H V C CNN\r\n' +
'F2 "" 0 0 60 H V C CNN\r\n' +
'F3 "" 0 0 60 H V C CNN\r\n' +
'DRAW\r\n' +
'A 0 -75 25 901 1799 1 1 0 N 0 -50 -25 -75\r\n' + 
'A 0 -75 25 -1799 -901 1 1 0 N -25 -75 0 -100\r\n' +
'A 0 -25 25 901 1799 1 1 0 N 0 0 -25 -25\r\n' +
'A 0 -25 25 -1799 -901 1 1 0 N -25 -25 0 -50\r\n' +
'A 0 25 25 901 1799 1 1 0 N 0 50 -25 25\r\n' +
'A 0 25 25 -1799 -901 1 1 0 N -25 25 0 0\r\n' +
'A 0 75 25 901 1799 1 1 0 N 0 100 -25 75\r\n' +
'A 0 75 25 -1799 -901 1 1 0 N -25 75 0 50\r\n' +
'X P$1 1 0 150 50 D 40 40 1 1 P\r\n' +
'X 2 2 0 -150 50 U 40 40 1 1 P\r\n' +
'ENDDRAW\r\n' +
'ENDDEF';

		var mpu = 'DEF ~MPU-9150 MPU9150 0 1 N Y 1 L N\r\n' + 
'F0 "MPU9150" 0 0 60 H V C CNN\r\n' + 
'F1 "MPU-9150" 50 -100 60 H I C CNN\r\n' + 
'F2 "" 0 0 60 H V C CNN\r\n' + 
'F3 "" 0 0 60 H V C CNN\r\n' + 
'DRAW\r\n' + 
'#P 2 1 0 0  -550 -450  550 -450 N\r\n' + 
'#P 2 1 0 0 -550 450 -550 -450 N\r\n' + 
'#P 2 1 0 0 550 -450 550 450 N\r\n' + 
'#P 2 1 0 0 550 450 -550 450 N\r\n' + 
'P 2 1 0 0 50 50 200 200 N\r\n' + 
'P 2 1 0 0 50 50 200 230 N\r\n' + 
'X CLKIN1 1 -600 250 100 R 28 28 1 1 P\r\n' + 
'X RESV2 2 -600 150 100 R 28 28 1 1 N\r\n' + 
'X VDD3 3 -600 50 100 R 28 28 1 1 W\r\n' + 
'X RESV4 4 -600 -50 100 R 28 28 1 1 N\r\n' + 
'X RESV5 5 -600 -150 100 R 28 28 1 1 N\r\n' + 
'X ES-DA6 6 -600 -250 100 R 28 28 1 1 B\r\n' + 
'X ES-CL7 7 -250 -500 100 U 28 28 1 1 B\r\n' + 
'X VLOGIC8 8 -150 -500 100 U 28 28 1 1 W\r\n' + 
'X AD09 9 -50 -500 100 U 28 28 1 1 P\r\n' + 
'X REGOUT10 10 50 -500 100 U 28 28 1 1 B\r\n' + 
'X CPOUT20 20 150 500 100 D 28 28 1 1 B\r\n' + 
'X FSYNC11 11 150 -500 100 U 28 28 1 1 B\r\n' + 
'X RESV21 21 50 500 100 D 28 28 1 1 N\r\n' + 
'X INT12 12 250 -500 100 U 28 28 1 1 B\r\n' + 
'X CLKOUT22 22 -50 500 100 D 28 28 1 1 B\r\n' + 
'X VDD13 13 600 -250 100 L 28 28 1 1 W\r\n' + 
'X SCL23 23 -150 500 100 D 28 28 1 1 B\r\n' + 
'X RESV14 14 600 -150 100 L 28 28 1 1 N\r\n' + 
'X SDA24 24 -250 500 100 D 28 28 1 1 B\r\n' + 
'X GND15 15 600 -50 100 L 28 28 1 1 W\r\n' + 
'X RESV16 16 600 50 100 L 28 28 1 1 N\r\n' + 
'X GND17 17 600 150 100 L 28 28 1 1 W\r\n' + 
'X GND18 18 600 250 100 L 28 28 1 1 W\r\n' + 
'X RESV19 19 250 500 100 D 28 28 1 1 N\r\n' + 
'ENDDRAW\r\n' + 
'ENDDEF';

		var comp = new Component();
		comp.parseComponent(mpu);
		console.log(comp);
		
		comp.draw();
		
		var scrolls = $('.canvas-scroll');
		
		scrolls.each(function(index, item) {
			item = $(item);
			var cvs = item.find('canvas');
			
			item.css({ 'height': cvs.css('height') - 2, 'overflow-y': 'scroll' });
			item.on('scroll', function(e) {
				e.preventDefault();
				
				var scroll = item.scrollTop();
				
				if(e.ctrlKey) {
					panHorizontal(1 - scroll);
				}
				else if(e.altKey) {
					panVertical(1 - scroll);
				}
				else if(scroll < 1) {	
					zoomIn();
					//canvas.zoomToPoint(new fabric.Point(cvs.width() - cvs.data('mouseX'), cvs.height() - cvs.data('mouseY')), canvas.getZoom() + SCALE_FACTOR);
				}
				else if(scroll > 1) {
					zoomOut();
					//canvas.zoomToPoint(new fabric.Point(cvs.width() - cvs.data('mouseX'), cvs.height() - cvs.data('mouseY')), canvas.getZoom() - SCALE_FACTOR);
				}
				
				item.scrollTop(1);
			});
			
			item.scrollTop(1);
			
			var bottom = $('<div style="overflow-x: scroll; position: absolute" />');
			$(document.body).append(bottom);
			bottom.css({ left: item.css('left'), 'height': '20px', 'top': item.position().top + item.height(), 'width': cvs.width() });
			
			//resetView();
			
			cvs.on('mousemove', function(e) {
				cvs.data('mouseX', e.clientX);
				cvs.data('mouseY', e.clientY);
			});
		});
	});
	</script>
</body>
</html>
